{"version":3,"sources":["stylefy/impl/dom.cljs"],"mappings":"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","names":["stylefy.impl.dom/styles-in-dom","cljs.core.atom.cljs$core$IFn$_invoke$arity$1","stylefy.impl.dom/dom-update-requested?","stylefy.impl.dom/styles-as-css","stylefy.impl.dom/keyframes-in-use","stylefy.impl.dom/font-faces-in-use","stylefy.impl.dom/custom-tags-in-use","stylefy.impl.dom/custom-classes-in-use","stylefy.impl.dom/stylefy-node-id","stylefy.impl.dom/stylefy-constant-node-id","stylefy.impl.dom/stylefy-base-node","stylefy.impl.dom/stylefy-instance-id","stylefy.impl.dom/style-by-hash","style-hash","cljs.core/deref","cljs.core.get.cljs$core$IFn$_invoke$arity$2","stylefy.impl.dom/update-style-tags!","node-stylefy","node-stylefy-constant","styles-in-css","cljs.core.map.cljs$core$IFn$_invoke$arity$2","cljs.core.comp.cljs$core$IFn$_invoke$arity$2","cljs.core/keys","keyframes-in-css","cljs.core/vals","font-faces-in-use","custom-tags-in-use","custom-classes-in-use","new-style-constant-css","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/str","cljs.core.concat.cljs$core$IFn$_invoke$arity$variadic","new-style-css","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","dommy.core/text","dommy.core/set-text!","stylefy.impl.dom/mark-all-styles-added-in-dom!","seq__38551","cljs.core/seq","chunk__38552","count__38553","i__38554","temp__5735__auto__","cljs.core/chunked-seq?","c__4609__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/first","cljs.core/next","cljs.core/reset!","stylefy.impl.dom/get-stylefy-node","id","base-node","instance-id","final-id","js/document","dommy.core/selector","stylefy.impl.dom/update-dom","and__4174__auto__","e38556","stylefy.impl.cache.cache_styles.cljs$core$IFn$_invoke$arity$2","e","stylefy.impl.log/warn","stylefy.impl.cache.clear_styles.cljs$core$IFn$_invoke$arity$1","stylefy.impl.log/error","stylefy.impl.dom/update-dom-if-requested","stylefy.impl.dom/request-asynchronous-dom-update","stylefy.impl.state/stylefy-initialised?","c__37015__auto__","cljs.core.async.chan.cljs$core$IFn$_invoke$arity$1","cljs.core.async.impl.dispatch/run","f__37016__auto__","switch__36947__auto__","state_38562","state_val_38563","inst_38560","cljs.core.async.impl.ioc-helpers/return-chan","statearr-38565","state-machine__36948__auto__","ret-value__36949__auto__","result__36950__auto__","cljs.core/keyword-identical?","e38567","js/Object","ex__36951__auto__","statearr-38568","cljs.core.async.impl.ioc-helpers/process-exception","state__37017__auto__","statearr-38571","cljs.core.async.impl.ioc-helpers/USER-START-IDX","cljs.core.async.impl.ioc-helpers/run-state-machine-wrapped","p__38575","map__38576","cljs.core/PROTOCOL_SENTINEL","cljs.core/hash-map","stylefy.impl.dom/init-multi-instance","multi-instance","options","js/Error","cljs.core.pr_str.cljs$core$IFn$_invoke$arity$variadic","stylefy.impl.dom/init-cache","cljs.core.not_EQ_.cljs$core$IFn$_invoke$arity$2","stylefy.impl.cache.use_caching_BANG_.cljs$core$IFn$_invoke$arity$2","cached-styles","stylefy.impl.cache/read-cache-value","stylefy.impl.cache/cache-key-styles","or__4185__auto__","cljs.core/merge","p1__38582#","reagent.core.atom.cljs$core$IFn$_invoke$arity$1","p__38588","map__38589","stylefy.impl.dom/save-style!","css","hash","style","style-to-be-saved","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$4","cljs.core/assoc","stylefy.impl.dom/style-in-dom?","cljs.core/boolean","stylefy.impl.dom/add-keyframes","identifier","garden-syntax","garden.core.css.cljs$core$IFn$_invoke$arity$variadic","stylefy.impl.dom/add-font-face","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$3","cljs.core/conj","stylefy.impl.dom/add-tag","tag-css","stylefy.impl.dom/add-class","class-as-css"],"sourcesContent":["(ns stylefy.impl.dom\r\n  (:require [dommy.core :as dommy]\r\n            [reagent.core :as r]\r\n            [garden.core :refer [css]]\r\n            [cljs.core.async :refer [<! timeout]]\r\n            [stylefy.impl.cache :as cache]\r\n            [stylefy.impl.conversion :as conversion]\r\n            [garden.stylesheet :refer [at-media at-keyframes at-font-face]]\r\n            [stylefy.impl.log :as log]\r\n            [stylefy.impl.state :as state])\r\n  (:require-macros\r\n    [reagent.ratom :refer [run!]]\r\n    [cljs.core.async.macros :refer [go]]))\r\n\r\n\r\n(def styles-in-dom (atom {})) ; style hash -> r/atom with boolean value\r\n(def ^:private dom-update-requested? (atom false))\r\n\r\n(def styles-as-css (atom {})) ; style hash -> map containing keys: ::css\r\n\r\n(def keyframes-in-use (atom {})) ; keyframe identifier -> css\r\n(def font-faces-in-use (atom [])) ; Vector of maps containing keys: ::css\r\n(def custom-tags-in-use (atom [])) ; Vector of maps containing keys: ::css\r\n(def custom-classes-in-use (atom [])) ; Vector of maps containing keys: ::css\r\n\r\n(def ^:private stylefy-node-id \"#_stylefy-styles_\")\r\n(def ^:private stylefy-constant-node-id \"#_stylefy-constant-styles_\")\r\n(def ^:private stylefy-base-node (atom nil)) ; Used when running multiple instances of stylefy on the same page\r\n(def stylefy-instance-id (atom nil)) ; Used when running multiple instances of stylefy on the same page\r\n\r\n(defn style-by-hash [style-hash]\r\n  (when style-hash\r\n    (get @styles-as-css style-hash)))\r\n\r\n(defn- update-style-tags!\r\n  [node-stylefy node-stylefy-constant]\r\n  (let [styles-in-css          (map (comp ::css style-by-hash) (keys @styles-as-css))\r\n        keyframes-in-css       (vals @keyframes-in-use)\r\n        font-faces-in-use      (map ::css @font-faces-in-use)\r\n        custom-tags-in-use     (map ::css @custom-tags-in-use)\r\n        custom-classes-in-use  (map ::css @custom-classes-in-use)\r\n        new-style-constant-css (apply str (concat font-faces-in-use\r\n                                                  keyframes-in-css\r\n                                                  custom-tags-in-use\r\n                                                  custom-classes-in-use))\r\n        new-style-css          (apply str styles-in-css)]\r\n    ; Do not update this node contents if there are no new styles to be added.\r\n    ; This is important, because even if setting the same contents should have no effect,\r\n    ; it can cause font flickering in some browsers.\r\n    (when-not (= (dommy/text node-stylefy-constant) new-style-constant-css)\r\n      (dommy/set-text! node-stylefy-constant new-style-constant-css))\r\n\r\n    (dommy/set-text! node-stylefy new-style-css)))\r\n\r\n(defn- mark-all-styles-added-in-dom! []\r\n  (doseq [style-hash (keys @styles-in-dom)]\r\n    (reset! (get @styles-in-dom style-hash) true)))\r\n\r\n(defn- get-stylefy-node [id base-node instance-id]\r\n  (let [final-id (str id (when instance-id (str instance-id)))]\r\n    (if (nil? base-node)\r\n      (dommy/sel1 final-id)\r\n      (dommy/sel1 base-node final-id))))\r\n\r\n(defn update-dom\r\n  []\r\n  (let [node-stylefy (get-stylefy-node stylefy-node-id @stylefy-base-node @stylefy-instance-id)\r\n        node-stylefy-constant (get-stylefy-node stylefy-constant-node-id @stylefy-base-node @stylefy-instance-id)]\r\n    (if (and node-stylefy node-stylefy-constant)\r\n      (do (update-style-tags! node-stylefy node-stylefy-constant)\r\n          (reset! dom-update-requested? false)\r\n\r\n          (try\r\n            (cache/cache-styles @styles-as-css @stylefy-instance-id)\r\n            (catch :default e\r\n              (log/warn (str \"Unable to cache styles, error: \" e))\r\n              (cache/clear-styles @stylefy-instance-id)\r\n              e))\r\n\r\n          (mark-all-styles-added-in-dom!))\r\n      (log/error \"stylefy is unable to find the required <style> tags!\"))))\r\n\r\n(defn- update-dom-if-requested\r\n  []\r\n  (when @dom-update-requested?\r\n    (update-dom)))\r\n\r\n(defn- request-asynchronous-dom-update\r\n  []\r\n  (when @state/stylefy-initialised?\r\n    (when-not @dom-update-requested?\r\n      (reset! dom-update-requested? true)\r\n      (go\r\n        (update-dom))\r\n      nil)))\r\n\r\n(defn init-multi-instance [{:keys [multi-instance] :as options}]\r\n  (let [base-node (:base-node multi-instance)\r\n        instance-id (:instance-id multi-instance)]\r\n    (assert (or (nil? instance-id)\r\n                (string? instance-id))\r\n            (str \"instance-id must be string. Got: \" (pr-str base-node instance-id)))\r\n    (reset! stylefy-base-node base-node)\r\n    (reset! stylefy-instance-id instance-id)))\r\n\r\n(defn init-cache [options]\r\n  (when (not= (:use-caching? options) false)\r\n    (cache/use-caching! (:cache-options options) @stylefy-instance-id)\r\n\r\n    (when-let [cached-styles (cache/read-cache-value\r\n                               (cache/cache-key-styles @stylefy-instance-id))]\r\n      (reset! styles-as-css (or cached-styles {}))\r\n      (reset! styles-in-dom (apply merge (map\r\n                                           ; Note: r/atom, to be usable in component render methods.\r\n                                           #(-> {% (r/atom false)})\r\n                                           (keys cached-styles)))))))\r\n\r\n(defn save-style!\r\n  \"Stores the style in an atom. The style is going to be added into the DOM soon.\"\r\n  [{:keys [css hash] :as style}]\r\n  (assert css \"Unable to save empty style!\")\r\n  (assert hash \"Unable to save style without hash!\")\r\n  (let [style-to-be-saved {::css css}]\r\n    (swap! styles-as-css assoc hash style-to-be-saved)\r\n    (swap! styles-in-dom assoc hash (r/atom false)) ; Note: r/atom, to be usable in component render methods.\r\n    (request-asynchronous-dom-update)))\r\n\r\n(defn style-in-dom? [style-hash]\r\n  ; Note: This function does Reagent atom dereference.\r\n  ; If called inside a component render method (via use-style), it causes the component to re-render\r\n  ; itself if the \"CSS in DOM\" state of this specific style hash is changed.\r\n  (boolean @(get @styles-in-dom style-hash)))\r\n\r\n(defn add-keyframes [identifier garden-syntax]\r\n  (swap! keyframes-in-use assoc identifier (css garden-syntax))\r\n  (request-asynchronous-dom-update)\r\n  nil)\r\n\r\n(defn add-font-face [garden-syntax]\r\n  (swap! font-faces-in-use conj {::css (css garden-syntax)})\r\n  (request-asynchronous-dom-update)\r\n  nil)\r\n\r\n(defn add-tag [tag-css]\r\n  (swap! custom-tags-in-use conj {::css tag-css})\r\n  (request-asynchronous-dom-update)\r\n  nil)\r\n\r\n(defn add-class [class-as-css]\r\n  (swap! custom-classes-in-use conj {::css class-as-css})\r\n  (request-asynchronous-dom-update)\r\n  nil)\r\n"]}